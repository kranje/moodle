{"version":3,"file":"questionnaire.min.js","sources":["../src/questionnaire.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Questionnaire JS module.\n *\n * @module     mod_threesixo/questionnaire\n * @class      questionnaire\n * @copyright  2016 Jun Pataleta <jun@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Notification from 'core/notification';\nimport Ajax from 'core/ajax';\nimport {get_string as getString, get_strings as getStrings} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {add as addToast} from 'core/toast';\n\n/**\n * Selectors for the questionnaire page.\n *\n * @type {{questionItem: string, questionnaireTable: string, ratingOption: string, commentItem: string}}\n */\nconst selectors = {\n    commentItem: 'textarea[data-region=\"comment-item\"]',\n    questionnaireTable: '[data-region=\"questionnaire\"]',\n    ratingOption: 'input[type=radio]',\n    questionItem: '[data-region=\"question-item\"]',\n};\n\n/**\n * Array of responses to the items in the questionnaire with item ID for the key and the response for the value.\n */\nconst responses = [];\n\n/**\n * Initialiser function.\n */\nexport const init = () => {\n    registerEvents();\n\n    const questionItems = document.querySelectorAll(selectors.questionItem);\n    questionItems.forEach(option => {\n        responses[option.getAttribute('data-itemid')] = null;\n    });\n\n    const questionnaireTable = document.querySelector(selectors.questionnaireTable);\n    const fromUser = questionnaireTable.getAttribute('data-fromuserid');\n    const toUser = questionnaireTable.getAttribute('data-touserid');\n    const threesixtyId = questionnaireTable.getAttribute('data-threesixtyid');\n\n    const promises = Ajax.call([\n        {\n            methodname: 'mod_threesixo_get_responses',\n            args: {\n                threesixtyid: threesixtyId,\n                fromuserid: fromUser,\n                touserid: toUser\n            }\n        }\n    ]);\n\n    promises[0].then(result => {\n        result.responses.forEach(response => {\n            responses[response.item] = response.value;\n            const responseItemId = parseInt(response.item);\n\n            questionItems.forEach(questionItem => {\n                const questionItemId = parseInt(questionItem.getAttribute('data-itemid'));\n                if (questionItemId === responseItemId) {\n                    const options = questionItem.querySelectorAll(selectors.ratingOption);\n                    if (options.length) {\n                        // Ratings.\n                        options.forEach(option => {\n                            // Mark selected option as selected.\n                            const selectedValue = option.value;\n                            if (selectedValue === response.value) {\n                                handleOptionActivation(option);\n                            }\n                        });\n                    } else {\n                        // Comments.\n                        const commentTextArea = questionItem.querySelector(selectors.commentItem);\n                        if (commentTextArea) {\n                            commentTextArea.value = response.value;\n                        }\n                    }\n                }\n            });\n        });\n        return true;\n    }).catch(Notification.exception);\n};\n\n/**\n * Registers the event listeners for the questionnaire.\n */\nconst registerEvents = () => {\n    document.addEventListener('change', e => {\n        const ratingOption = e.target.closest(selectors.ratingOption);\n        if (ratingOption) {\n            if (ratingOption.checked) {\n                handleOptionActivation(ratingOption);\n            }\n        }\n    });\n\n    document.addEventListener('click', e => {\n        const ratingOption = e.target.closest(selectors.ratingOption);\n        if (ratingOption) {\n            const ratingOptionLabel = ratingOption.closest('label');\n            if (ratingOptionLabel) {\n                ratingOptionLabel.classList.add('focus');\n            }\n        }\n    });\n\n    document.addEventListener('blur', e => {\n        const ratingOption = e.target.closest(selectors.ratingOption);\n        if (ratingOption) {\n            const ratingOptionLabel = ratingOption.closest('label');\n            if (ratingOptionLabel) {\n                ratingOptionLabel.classList.remove('focus');\n            }\n        }\n    });\n\n    const btnSaveFeedback = document.getElementById('save-feedback');\n    btnSaveFeedback.addEventListener('click', () => {\n        saveResponses(false);\n    });\n\n    const btnSubmitFeedback = document.getElementById('submit-feedback');\n    btnSubmitFeedback.addEventListener('click', () => {\n        saveResponses(true);\n    });\n};\n\n/**\n * Handles the selection of a rated question's option.\n *\n * @param {HTMLElement} ratingOption The selected option for the given rated question.\n */\nconst handleOptionActivation = ratingOption => {\n    const optionGroup = ratingOption.closest(selectors.questionItem);\n    const itemId = optionGroup.getAttribute('data-itemid');\n    const options = optionGroup.querySelectorAll(selectors.ratingOption);\n\n    // Deselect the option that has been selected.\n    options.forEach(option => {\n        const optionLabel = option.nextElementSibling;\n        if (optionLabel.classList.contains('btn-success')) {\n            optionLabel.classList.remove('btn-success');\n            optionLabel.classList.add('btn-secondary');\n            option.checked = false;\n        }\n    });\n\n    // Mark selected option as selected.\n    const selectedLabel = ratingOption.nextElementSibling;\n    selectedLabel.classList.remove('btn-secondary');\n    selectedLabel.classList.remove('btn-info');\n    selectedLabel.classList.add('btn-success');\n    ratingOption.checked = true;\n\n    // Add this selected value to the array of responses.\n    responses[itemId] = ratingOption.value;\n};\n\n/**\n * Save the responses.\n *\n * @param {boolean} finalise\n */\nconst saveResponses = finalise => {\n    const comments = document.querySelectorAll(selectors.commentItem);\n    comments.forEach(comment => {\n        responses[comment.getAttribute('data-itemid')] = comment.value.trim();\n    });\n\n    const questionnaireTable = document.querySelector(selectors.questionnaireTable);\n    const toUser = parseInt(questionnaireTable.getAttribute('data-touserid'));\n    const toUserFullname = questionnaireTable.getAttribute('data-tousername');\n    const threesixtyId = parseInt(questionnaireTable.getAttribute('data-threesixtyid'));\n    const anonymous = parseInt(questionnaireTable.getAttribute('data-anonymous'));\n\n    if (anonymous && finalise) {\n        // Show confirmation dialogue to anonymise the feedback responses.\n        const messageStrings = [\n            {\n                key: 'finaliseanonymousfeedback',\n                component: 'mod_threesixo'\n            },\n            {\n                key: 'confirmfinaliseanonymousfeedback',\n                component: 'mod_threesixo',\n                param: {\n                    'name': toUserFullname\n                }\n            }\n        ];\n\n        getStrings(messageStrings, 'mod_threesixo').then(messages => {\n            return showConfirmationDialogue(messages[0], messages[1], threesixtyId, toUser, responses, finalise);\n        }).catch(Notification.exception);\n    } else {\n        // Just save the responses.\n        submitResponses(threesixtyId, toUser, responses, finalise);\n    }\n};\n\n/**\n * Send the responses to the server.\n *\n * @param {number} threesixtyId\n * @param {number} toUser\n * @param {array} responses\n * @param {boolean} finalise\n */\nconst submitResponses = (threesixtyId, toUser, responses, finalise) => {\n    var promises = Ajax.call([\n        {\n            methodname: 'mod_threesixo_save_responses',\n            args: {\n                threesixtyid: threesixtyId,\n                touserid: toUser,\n                responses: responses,\n                complete: finalise\n            }\n        }\n    ]);\n\n    let redirectUrl = null;\n    promises[0].then(response => {\n        if (response.result) {\n            redirectUrl = response.redirurl;\n            return getString('responsessaved', 'mod_threesixo');\n        }\n        return getString('errorresponsesavefailed', 'mod_threesixo');\n    }).then(message => {\n        return addToast(message, {});\n    }).then(() => {\n        if (finalise && redirectUrl) {\n            window.location = redirectUrl;\n        }\n        return true;\n    }).catch(Notification.exception);\n};\n\n/**\n * Renders the confirmation dialogue to submit and finalise the responses.\n *\n * @param {string} title\n * @param {string} confirmationMessage\n * @param {number} threesixtyId\n * @param {number} toUser\n * @param {Array} responses\n * @param {boolean} finalise\n */\nconst showConfirmationDialogue = async(title, confirmationMessage, threesixtyId, toUser, responses, finalise) => {\n    const confirmButtonText = await getString('finalise', 'mod_threesixo');\n    const confirmModal = await ModalFactory.create({\n        title: title,\n        body: confirmationMessage,\n        large: true,\n        type: ModalFactory.types.SAVE_CANCEL\n    });\n\n    confirmModal.setSaveButtonText(confirmButtonText);\n\n    // Display the dialogue.\n    confirmModal.show();\n\n    // On hide handler.\n    confirmModal.getRoot().on(ModalEvents.hidden, () => {\n        // Empty modal contents when it's hidden.\n        confirmModal.setBody('');\n    });\n\n    confirmModal.getRoot().on(ModalEvents.save, () => {\n        submitResponses(threesixtyId, toUser, responses, finalise);\n    });\n};\n"],"names":["selectors","responses","registerEvents","questionItems","document","querySelectorAll","forEach","option","getAttribute","questionnaireTable","querySelector","fromUser","toUser","threesixtyId","Ajax","call","methodname","args","threesixtyid","fromuserid","touserid","then","result","response","item","value","responseItemId","parseInt","questionItem","options","length","handleOptionActivation","commentTextArea","catch","Notification","exception","addEventListener","e","ratingOption","target","closest","checked","ratingOptionLabel","classList","add","remove","getElementById","saveResponses","optionGroup","itemId","optionLabel","nextElementSibling","contains","selectedLabel","finalise","comment","trim","toUserFullname","messageStrings","key","component","param","messages","showConfirmationDialogue","submitResponses","promises","complete","redirectUrl","redirurl","message","window","location","async","title","confirmationMessage","confirmButtonText","confirmModal","ModalFactory","create","body","large","type","types","SAVE_CANCEL","setSaveButtonText","show","getRoot","on","ModalEvents","hidden","setBody","save"],"mappings":"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"}