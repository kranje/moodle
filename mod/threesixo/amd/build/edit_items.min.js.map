{"version":3,"file":"edit_items.min.js","sources":["../src/edit_items.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD code for the frequently used comments chooser for the marking guide grading form.\n *\n * @module     mod_threesixo/edit_items\n * @class      edit_items\n * @copyright  2016 Jun Pataleta <jun@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport * as Templates from 'core/templates';\nimport * as Notification from 'core/notification';\nimport Ajax from 'core/ajax';\nimport * as Bank from 'mod_threesixo/question_bank';\nimport {eventTypes, notifyItemsUpdated} from 'mod_threesixo/events';\nimport {add as addToast} from 'core/toast';\nimport {get_string as getString} from \"core/str\";\nimport Pending from 'core/pending';\n\n/**\n * List of action selectors.\n *\n * @type {{DELETE: string, MOVE_UP: string, MOVE_DOWN: string}}\n */\nconst ACTIONS = {\n    DELETE: '[data-action=\"delete-item\"]',\n    MOVE_UP: '[data-action=\"move-item-up\"]',\n    MOVE_DOWN: '[data-action=\"move-item-down\"]',\n    PICK_QUESTION: '#btn-question-bank',\n};\n\nexport default class EditItems {\n    threesixtyId;\n\n    constructor(threesixtyid) {\n        this.threesixtyId = threesixtyid;\n        this.registerEvents();\n    }\n\n    refreshItemList() {\n        const pending = new Pending('mod_threesixo/refreshItems');\n        const editItems = this;\n        const promises = Ajax.call([\n            {\n                methodname: 'mod_threesixo_get_items',\n                args: {\n                    threesixtyid: editItems.threesixtyId\n                }\n            }\n        ]);\n        promises[0].then(function(response) {\n            const context = {\n                threesixtyid: editItems.threesixtyId\n            };\n\n            const items = [];\n            const itemCount = response.items.length;\n            response.items.forEach((value) => {\n                const item = value;\n                item.deletebutton = true;\n                item.moveupbutton = false;\n                item.movedownbutton = false;\n                item.type = value.typetext;\n                if (itemCount > 1) {\n                    if (value.position === 1) {\n                        item.movedownbutton = true;\n                    } else if (value.position === itemCount) {\n                        item.moveupbutton = true;\n                    } else if (value.position > 1 && value.position < itemCount) {\n                        item.moveupbutton = true;\n                        item.movedownbutton = true;\n                    }\n                }\n                items.push(item);\n            });\n            context.allitems = items;\n\n            return Templates.render('mod_threesixo/list_360_items', context);\n        }).then((compiledSource) => {\n            document.querySelector('[data-region=\"itemlist\"]').outerHTML = compiledSource;\n            return pending.resolve();\n        }).catch(Notification.exception);\n    }\n\n    callItemAction(action, itemId, successMessage) {\n        const threesixtyId = this.threesixtyId;\n        const promises = Ajax.call([\n            {\n                methodname: action,\n                args: {\n                    itemid: itemId\n                }\n            }\n        ]);\n        promises[0].then((response) => {\n            if (response.result) {\n                return successMessage;\n            }\n            const warnings = response.warnings.join($('<br/>'));\n            throw new Error(warnings);\n        }).then((message) => {\n            notifyItemsUpdated(threesixtyId);\n            return addToast(message, {});\n        }).catch(Notification.exception);\n    }\n\n    registerEvents() {\n        const editItems = this;\n\n        document.addEventListener('click', e => {\n            let actionButton = '';\n            let action = '';\n            let successMessage = '';\n            if (e.target.closest(ACTIONS.DELETE)) {\n                actionButton = e.target.closest(ACTIONS.DELETE);\n                action = 'mod_threesixo_delete_item';\n                successMessage = getString('itemdeleted', 'mod_threesixo');\n            } else if (e.target.closest(ACTIONS.MOVE_UP)) {\n                actionButton = e.target.closest(ACTIONS.MOVE_UP);\n                action = 'mod_threesixo_move_item_up';\n                successMessage = getString('itemmovedup', 'mod_threesixo');\n            } else if (e.target.closest(ACTIONS.MOVE_DOWN)) {\n                actionButton = e.target.closest(ACTIONS.MOVE_DOWN);\n                action = 'mod_threesixo_move_item_down';\n                successMessage = getString('itemmoveddown', 'mod_threesixo');\n            } else if (e.target.closest(ACTIONS.PICK_QUESTION)) {\n                e.preventDefault();\n\n                Bank.init(editItems.threesixtyId);\n            }\n\n            if (action) {\n                e.preventDefault();\n\n                // Remove the tooltip markup from the DOM. For some reason calling .tooltip('dispose') mucks Behat tests.\n                const tooltipId = actionButton.getAttribute('aria-describedby');\n                if (tooltipId) {\n                    const tooltip = document.querySelector(`#${tooltipId}`);\n                    if (tooltip) {\n                        tooltip.remove();\n                    }\n                }\n\n                const itemId = actionButton.dataset.itemid;\n                editItems.callItemAction(action, itemId, successMessage);\n            }\n        });\n\n        document.addEventListener(eventTypes.itemsUpdated, function() {\n            editItems.refreshItemList();\n        });\n    }\n}\n"],"names":["ACTIONS","constructor","threesixtyid","threesixtyId","registerEvents","refreshItemList","pending","Pending","editItems","this","Ajax","call","methodname","args","then","response","context","items","itemCount","length","forEach","value","item","deletebutton","moveupbutton","movedownbutton","type","typetext","position","push","allitems","Templates","render","compiledSource","document","querySelector","outerHTML","resolve","catch","Notification","exception","callItemAction","action","itemId","successMessage","itemid","result","warnings","join","Error","message","addEventListener","e","actionButton","target","closest","preventDefault","Bank","init","tooltipId","getAttribute","tooltip","remove","dataset","eventTypes","itemsUpdated"],"mappings":"unDAsCMA,eACM,8BADNA,gBAEO,+BAFPA,kBAGS,iCAHTA,sBAIa,mDAMfC,YAAYC,yLACHC,aAAeD,kBACfE,iBAGTC,wBACUC,QAAU,IAAIC,iBAAQ,8BACtBC,UAAYC,KACDC,cAAKC,KAAK,CACvB,CACIC,WAAY,0BACZC,KAAM,CACFX,aAAcM,UAAUL,iBAI3B,GAAGW,MAAK,SAASC,gBAChBC,QAAU,CACZd,aAAcM,UAAUL,cAGtBc,MAAQ,GACRC,UAAYH,SAASE,MAAME,cACjCJ,SAASE,MAAMG,SAASC,cACdC,KAAOD,MACbC,KAAKC,cAAe,EACpBD,KAAKE,cAAe,EACpBF,KAAKG,gBAAiB,EACtBH,KAAKI,KAAOL,MAAMM,SACdT,UAAY,IACW,IAAnBG,MAAMO,SACNN,KAAKG,gBAAiB,EACfJ,MAAMO,WAAaV,UAC1BI,KAAKE,cAAe,EACbH,MAAMO,SAAW,GAAKP,MAAMO,SAAWV,YAC9CI,KAAKE,cAAe,EACpBF,KAAKG,gBAAiB,IAG9BR,MAAMY,KAAKP,SAEfN,QAAQc,SAAWb,MAEZc,UAAUC,OAAO,+BAAgChB,YACzDF,MAAMmB,iBACLC,SAASC,cAAc,4BAA4BC,UAAYH,eACxD3B,QAAQ+B,aAChBC,MAAMC,aAAaC,WAG1BC,eAAeC,OAAQC,OAAQC,sBACrBzC,aAAeM,KAAKN,aACTO,cAAKC,KAAK,CACvB,CACIC,WAAY8B,OACZ7B,KAAM,CACFgC,OAAQF,WAIX,GAAG7B,MAAMC,cACVA,SAAS+B,cACFF,qBAELG,SAAWhC,SAASgC,SAASC,MAAK,mBAAE,gBACpC,IAAIC,MAAMF,aACjBjC,MAAMoC,yCACc/C,eACZ,cAAS+C,QAAS,OAC1BZ,MAAMC,aAAaC,WAG1BpC,uBACUI,UAAYC,KAElByB,SAASiB,iBAAiB,SAASC,QAC3BC,aAAe,GACfX,OAAS,GACTE,eAAiB,MACjBQ,EAAEE,OAAOC,QAAQvD,iBACjBqD,aAAeD,EAAEE,OAAOC,QAAQvD,gBAChC0C,OAAS,4BACTE,gBAAiB,mBAAU,cAAe,kBACnCQ,EAAEE,OAAOC,QAAQvD,kBACxBqD,aAAeD,EAAEE,OAAOC,QAAQvD,iBAChC0C,OAAS,6BACTE,gBAAiB,mBAAU,cAAe,kBACnCQ,EAAEE,OAAOC,QAAQvD,oBACxBqD,aAAeD,EAAEE,OAAOC,QAAQvD,mBAChC0C,OAAS,+BACTE,gBAAiB,mBAAU,gBAAiB,kBACrCQ,EAAEE,OAAOC,QAAQvD,yBACxBoD,EAAEI,iBAEFC,KAAKC,KAAKlD,UAAUL,eAGpBuC,OAAQ,CACRU,EAAEI,uBAGIG,UAAYN,aAAaO,aAAa,uBACxCD,UAAW,OACLE,QAAU3B,SAASC,yBAAkBwB,YACvCE,SACAA,QAAQC,eAIVnB,OAASU,aAAaU,QAAQlB,OACpCrC,UAAUiC,eAAeC,OAAQC,OAAQC,oBAIjDV,SAASiB,iBAAiBa,mBAAWC,cAAc,WAC/CzD,UAAUH"}